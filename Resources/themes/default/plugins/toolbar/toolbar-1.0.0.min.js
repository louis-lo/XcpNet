/*!
 * pc端右手边工具条脚本，实现用户登录注册功能，加入购物车，显示购物车产品列表和删除购物车功能
 * Requires cnaws.js，passport.js，parabola.min.js，shoppingCart.js，artTemplete.js and jQuery
 * @version 1.0.0
 * @author liu mixoaxin  2016-07-27
 */
+function(n,t){"use strict";var i=function(n){return t.querySelector(n)},r=function(t){var r=this,i={cartInstance:new Cnaws.Cart,flyItemSelector:"#flyItem",cartCountSelector:"span.jsCount,div.jsCount",btnCartSelector:".btnCart",btnDelCartSelector:"i.del-btn",captchaImgSelector:"#captchaImg",captchaLinkSelector:"#captchaLink",cartContainerSelector:"#cartInfo",loginForm:n("#formLogin"),isFly:!0,onMoveComplete:null,onAddComplete:null,onBeforeAdd:null};this.options=n.extend({},i,t||{});this.passport();this.onlineService();this.parabola();this.shopCartInstance=this.shopCart()};r.prototype.passport=function(){var t=this,r=function(){Cnaws.changeCaptcha(t.options.captchaImgSelector,"login")},u=i(this.options.captchaLinkSelector);u!=null&&(r(),i(this.options.captchaLinkSelector).onclick=function(){r()},Cnaws.Passport.Init({targetUrl:location.href}),this.options.loginForm.jqxValidator({hintType:"label",animationDuration:0,rules:[{input:"#UserName",message:" ",action:"keyup, blur",rule:"required"},{input:"#Password",message:" ",action:"keyup, blur",rule:"required"},{input:"#Captcha",message:" ",action:"keyup, blur",rule:"required"}]}),this.options.loginForm.submit(function(n){n.preventDefault();n.stopPropagation();t.options.loginForm.jqxValidator("validate")&&Cnaws.Passport.login(this,"#errmsg",t.options.captchaLinkSelector)}),n("#right_login").mouseover(function(){n(this).children(".dropdown").show()}).mouseout(function(){n(this).children(".dropdown").hide()}).mouseleave(function(){n(this).children(".dropdown").hide()}))};r.prototype.onlineService=function(){n("div.online-service").mouseover(function(){n(this).children(".dropdown").show()}).mouseout(function(){n(this).children(".dropdown").hide()}).mouseleave(function(){n(this).children(".dropdown").hide()})};r.prototype.parabola=function(){var r=this,u=i(this.options.flyItemSelector),o=i(this.options.btnCartSelector),f=i("#shopCart").querySelector("i"),e=funParabola(u,f,{speed:200,curvature:.0008,complete:function(){u.style.visibility="hidden"}});this.fly=function(n){var i=t.documentElement.scrollLeft||t.body.scrollLeft||0,f=t.documentElement.scrollTop||t.body.scrollTop||0;if(u.style.left=n.clientX+i+"px",u.style.top=n.clientY+f+"px",u.style.visibility="visible",e.position().move(),typeof r.options.onMoveComplete=="function")r.options.onMoveComplete(r)};n(this.options.btnCartSelector).each(function(n,t){t.addEventListener("click",function(n){var t=function(){var t=n.target.getAttribute("data-productid"),i=n.target.getAttribute("data-count");r.options.cartInstance.add(t,i,function(){if(r.shopCartInstance.loadList(),typeof r.options.onAddComplete=="function")r.options.onAddComplete(r,function(){r.options.isFly&&r.fly(n)});else r.fly(n,r.options.onMoveComplete)})};if(typeof r.options.onBeforeAdd=="function")r.options.onBeforeAdd(t);else t()})})};r.prototype.shopCart=function(){var t=this,r=function(){t.flowDrop.length>0&&(t.loadList(),t.cartContainer.mouseover(function(){t.flowDrop.show()}).mouseout(function(){t.flowDrop.hide()}).mouseleave(function(){t.flowDrop.hide()}));var r=200,i=n("#backToTop");n(window).scroll(function(){n(this).scrollTop()>r?i.removeClass("disabled"):i.addClass("disabled")});i.click(function(){return n("body,html").animate({scrollTop:0},800),!1})},u=function(){n(t.options.btnDelCartSelector).on("click",function(){var r=n(this);t.options.cartInstance.del(r.data("cartid"),function(){r.parent("li").remove();i(-1)})})},i=function(i){if(i){var r=n(t.options.cartCountSelector);i<0&&(i=parseInt(r.get(1).innerText.replace("(","").replace(")",""))+i);r.html(i)}else t.options.cartInstance.getCount(t.options.cartCountSelector)};return this.flowDrop=n("#flowDrop"),this.cartContainer=n(this.options.cartContainerSelector),this.loadList=function(){t.options.cartInstance.getList(function(n){var f=template("tmpl-cartList",n),r=t.cartContainer.find(".bar");r.find(".cart_goods").remove();r.append(f);u();i()})},r(),this};window.Toolbar=r}($,document);