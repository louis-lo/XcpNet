/*!
 *pc端确认订单页面操作脚本
 * Requires jQuery v1.7 or later
 * Created by liu mixoaxin on 2016-07-15
 */
+function(n,t){"use strict";var i=function(t){return n.getElementById(t)},r=function(n){n.preventDefault();n.stopPropagation()},u=function(n){var s={cartUrl:Cnaws.getPassUrl("/cart"),freightUrl:Cnaws.getPassUrl("/buy/freight"),getPaymentUrl:function(n){return Cnaws.getPassUrl("/buy/payment/"+n)},delAddressUrl:Cnaws.getPassUrl("/shippingaddress/delete"),areaCountyUrl:"/country/",setDefaultUrl:Cnaws.getPassUrl("/shippingaddress/setDefault")};n=t.extend({},s,n||{});var u={btnSwitchAddress:t("a.jsAdr-switch"),defaultAdrs:"#default_A",postTo:t("#postTo"),addressName:t("#recName"),btnBack:i("btnBack"),totalMoney:i("TotalMoney"),form:i("form"),adrsForm:t("#adrsForm"),btnSubmit:i("btnSubmit")},o=function(){var n=t("#Mobile");return f().jqxValidator("hide"),f().jqxValidator({scroll:!1,rules:[{input:"#Consignee",message:"收货人不能为空",action:"keyup, blur",rule:"required"},{input:"#Address",message:"详细地址不能为空",action:"keyup, blur",rule:"required"},{input:"#Mobile",message:"手机号码不能为空",action:"keyup, blur",rule:"required"},{input:"#area_counties",message:"县、区不能为空",action:"keyup, blur",rule:function(n){var t=n.val();if(t!="")return parseInt(t)>0}},{input:"#Mobile",message:"手机号码无效",action:"keyup, blur",rule:function(n){var t=n.val(),i;if(t!==""){i=/^\s*|\s*$/g;t=t.replace(i,"");return/^1[3578][01379]\d{8}$/g.test(t)||/^1[34578][01256]\d{8}$/g.test(t)||/^(134[012345678]\d{7}|1[34578][012356789]\d{8})$/g.test(t)?!0:!1}return!0}}]}),f().jqxValidator("validate")},e=function(){if(o()){var n=f();Cnaws.postAjax(n.attr("action"),n.serialize(),function(n){n.code==-200?location.reload():ShowBox.showErrorByCode(n.code)},null)}},h=function(){var n=[];return t("div[data-orderid]").each(function(i,r){n.push(t(r).data("orderid")+"_"+t(r).find("textarea").val())}),"@"+n.join("@")},f=function(){return!u.adrsForm||u.adrsForm.length===0?t("#adrsForm"):u.adrsForm};i("area")!=null&&Cnaws.Area.Init("area",n.areaCountyUrl,n.location);t("input.jsAdr-Del").click(function(i){r(i);var u=new Xalert(this,{tmpl:"确定要删除收货地址吗？",callback:function(i){var r=t(i.target).parent(),u=r.data("addressid");Cnaws.postAjax(n.delAddressUrl,{Id:u},function(n){i.close();n.code==-200?location.reload():ShowBox.showErrorByCode(n.code)},null)}});u.show()});t("input.jsAdr-Edit").click(function(i){r(i);var u=new Xalert(this,{tmpl:"#tmpl-address",height:"380px",width:"715px",onShow:function(i){var r=t(i.target).parent(),u=r.data("addressid");Cnaws.Area.Init("area",n.areaCountyUrl,r.data("county"));i.content.find('input[name="Id"]').val(u);i.content.find("#Consignee").val(r.find(".jsAdr-name").text());i.content.find("#Address").val(r.data("address"));i.content.find("#PostId").val(r.data("postid"));i.content.find("#Mobile").val(r.find(".jsAdr-mobile").text())},callback:e});u.show()});t("#btnNewAddress").xalert({tmpl:"#tmpl-address",height:"380px",width:"715px",onShow:function(){Cnaws.Area.Init("area",n.areaCountyUrl,n.location)},callback:function(){o()&&e()}});u.btnSwitchAddress.click(function(){Cnaws.showInfo("正在切换地址，请稍后...")});u.btnBack.onclick=function(t){r(t);location.href=n.cartUrl};u.form.onsubmit=function(i){if(r(i),n.hasInvalid==="True"){Cnaws.showWarning("您的订单中含有无效的商品，请返回购物删除再提交！");return}if(n.adrsId<=0){Cnaws.showWarning("请先填写地址！");return}var u={Id:n.orderId,Address:n.adrsId,Message:h()};t.post(this.action,u,function(t){t.code===-200?location.href=n.getPaymentUrl(t.data.OrderId):ShowBox.showErrorByCode(t.code)},"json")};f().length!==0&&f().submit(function(n){r(n);e()})};window.Buy=u}(document,$);